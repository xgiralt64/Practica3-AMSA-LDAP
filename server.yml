---
- name: Configuració Server
  become: yes
  hosts: localhost
  vars:
    PASSWORD: "1234"
    BASE: "dc=amsa,dc=udl,dc=cat"

    PATH_PKI: "/etc/pki/tls"
    country: "ES"
    state: "Spain"
    locality: "Igualada"
    organization: "UdL"
    organizationalunit: "IT"
    email: "admin@udl.cat"


  tasks:
    - name: Actualitzar repositoris
      dnf:
        name: "*"
        state: latest

    - name: Instalar paquets necessaris
      dnf:
          name:
            - cyrus-sasl-devel
            - make
            - libtool
            - autoconf
            - libtool-ltdl-devel
            - openssl-devel
            - libdb-devel
            - tar
            - gcc
            - perl
            - perl-devel
            - wget
            - vim
          state: present
          update_cache: yes
    
    - name: Instalar OpenLDAP
      vars:
        openldap_ver: "2.6.3"
      shell: |
        wget ftp://ftp.openldap.org/pub/OpenLDAP/openldap-release/openldap-{{ openldap_ver }}.tgz
        tar xzf openldap-{{ openldap_ver }}.tgz
        cd openldap-{{ openldap_ver }}
        ./configure --prefix=/usr --sysconfdir=/etc --disable-static \
          --enable-debug --with-tls=openssl --with-cyrus-sasl --enable-dynamic \
          --enable-crypt --enable-spasswd --enable-slapd --enable-modules \
          --enable-rlookups --disable-sql --enable-ppolicy --enable-syslog
        make depend
        make
        cd contrib/slapd-modules/passwd/sha2
        make
        cd ../../../..
        make install
        cd contrib/slapd-modules/passwd/sha2
        make install
      args:
        chdir: /tmp

    - name: Crear grup ldap amb gid 55
      group:
        name: ldap
        gid: 55
        state: present

    - name: Crear usuari ldap amb uid 55
      user:
        name: ldap
        uid: 55
        group: ldap
        home: /var/lib/openldap
        shell: /usr/sbin/nologin
        system: yes
        create_home: no
        state: present

    - name: Crear directoris necessaris
      file:
        path: "{{ item }}"
        state: directory
        owner: ldap
        group: ldap
        mode: "0755"
      loop:
        - /var/lib/openldap
        - /etc/openldap/slapd.d

    - name: Assignar propietari al directori /var/lib/openldap
      file:
        path: /var/lib/openldap
        owner: ldap
        group: ldap
        state: directory

    - name: Assignar propietari i permisos a /etc/openldap/slapd.conf
      file:
        path: /etc/openldap/slapd.conf
        owner: root
        group: ldap
        mode: "0640"
        state: file

    - name: Crear unitat systemd per a slapd
      copy:
        dest: /etc/systemd/system/slapd.service
        owner: root
        group: root
        mode: '0644'
        content: |
          [Unit]
          Description=OpenLDAP Server Daemon
          After=syslog.target network-online.target
          Documentation=man:slapd
          Documentation=man:slapd-mdb

          [Service]
          Type=forking
          PIDFile=/var/lib/openldap/slapd.pid
          Environment="SLAPD_URLS=ldap:/// ldapi:/// ldaps:///"
          Environment="SLAPD_OPTIONS=-F /etc/openldap/slapd.d"
          ExecStart=/usr/libexec/slapd -u ldap -g ldap -h ${SLAPD_URLS} $SLAPD_OPTIONS

          [Install]
          WantedBy=multi-user.target

    - name: Recarregar systemd
      systemd:
        daemon_reload: yes

    - name: Habilitar el servei slapd
      systemd:
        name: slapd
        enabled: yes
    
    - name: Generar hash SSHA512 de la contrasenya
      command: >
        slappasswd -h "{SSHA512}"
        -o module-load=pw-sha2.la
        -o module-path=/usr/local/libexec/openldap
        -s {{ PASSWORD }}
      register: ldap_hash
      changed_when: true

    - name: Crear slapd.ldif
      copy:
        dest: /etc/openldap/slapd.ldif
        owner: ldap
        group: ldap
        mode: '0644'
        content: |
          dn: cn=config
          objectClass: olcGlobal
          cn: config
          olcArgsFile: /var/lib/openldap/slapd.args
          olcPidFile: /var/lib/openldap/slapd.pid
          olcTLSCipherSuite: TLSv1.2:HIGH:!aNULL:!eNULL
          olcTLSProtocolMin: 3.3

          dn: cn=schema,cn=config
          objectClass: olcSchemaConfig
          cn: schema

          dn: cn=module,cn=config
          objectClass: olcModuleList
          cn: module
          olcModulepath: /usr/libexec/openldap
          olcModuleload: back_mdb.la

          dn: cn=module,cn=config
          objectClass: olcModuleList
          cn: module
          olcModulepath: /usr/local/libexec/openldap
          olcModuleload: pw-sha2.la

          include: file:///etc/openldap/schema/core.ldif
          include: file:///etc/openldap/schema/cosine.ldif
          include: file:///etc/openldap/schema/nis.ldif
          include: file:///etc/openldap/schema/inetorgperson.ldif

          dn: olcDatabase=frontend,cn=config
          objectClass: olcDatabaseConfig
          objectClass: olcFrontendConfig
          olcDatabase: frontend
          olcPasswordHash: {{ ldap_hash.stdout }}
          olcAccess: to dn.base="cn=Subschema" by * read
          olcAccess: to *
            by dn.base="gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth" manage
            by * none

          dn: olcDatabase=config,cn=config
          objectClass: olcDatabaseConfig
          olcDatabase: config
          olcRootDN: cn=config
          olcAccess: to *
            by dn.base="gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth" manage
            by * none

    - name: Importar slapd.ldif a slapd.d
      command: >
        slapadd -n 0 -F /etc/openldap/slapd.d -l /etc/openldap/slapd.ldif
      args:
        chdir: /etc/openldap
      register: slapadd_result
      changed_when: true

    - name: Assegurar permisos de slapd.d
      file:
        path: /etc/openldap/slapd.d
        owner: ldap
        group: ldap
        recurse: yes
    
    - name: Activar i iniciar slapd
      systemd:
        name: slapd
        enabled: yes
        state: started
        daemon_reload: yes

    - name: Crear rootdn.ldif
      copy:
        dest: /etc/openldap/rootdn.ldif
        owner: ldap
        group: ldap
        mode: '0644'
        content: |
          dn: olcDatabase=mdb,cn=config
          objectClass: olcDatabaseConfig
          objectClass: olcMdbConfig
          olcDatabase: mdb
          olcDbMaxSize: 42949672960
          olcDbDirectory: /var/lib/openldap
          olcSuffix: {{ BASE }}
          olcRootDN: cn=admin,{{ BASE }}
          olcRootPW: {{ ldap_hash.stdout }}
          olcDbIndex: uid pres,eq
          olcDbIndex: cn,sn pres,eq,approx,sub
          olcDbIndex: mail pres,eq,sub
          olcDbIndex: objectClass pres,eq
          olcDbIndex: loginShell pres,eq
          olcAccess: to attrs=userPassword,shadowLastChange,shadowExpire
            by self write
            by anonymous auth
            by dn.subtree="gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth" manage
            by dn.subtree="ou=system,{{ BASE }}" read
            by * none
          olcAccess: to dn.subtree="ou=system,{{ BASE }}"
            by dn.subtree="gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth" manage
            by * none
          olcAccess: to dn.subtree="{{ BASE }}"
            by dn.subtree="gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth" manage
            by users read
            by * none



    - name: Importar base de dades MDB a cn=config
      command: >
        ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/rootdn.ldif
      register: ldapadd_result
      changed_when: true

    - name: Crear fitxer basedn.ldif
      copy:
        dest: /etc/openldap/basedn.ldif
        content: |
          dn: dc=amsa,dc=udl,dc=cat
          objectClass: dcObject
          objectClass: organization
          objectClass: top
          o: AMSA
          dc: amsa

          dn: ou=groups,dc=amsa,dc=udl,dc=cat
          objectClass: organizationalUnit
          objectClass: top
          ou: groups

          dn: ou=users,dc=amsa,dc=udl,dc=cat
          objectClass: organizationalUnit
          objectClass: top
          ou: users

          dn: ou=system,dc=amsa,dc=udl,dc=cat
          objectClass: organizationalUnit
          objectClass: top
          ou: system
        owner: ldap
        group: ldap
        mode: '0644'
    
    - name: Carreguem la configuració a la base de dades
      command: >
        ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/basedn.ldif
      register: ldapadd_result
      changed_when: true

    - name: Crear fitxer users.ldif amb OS proxy, grups i usuaris
      copy:
        dest: /etc/openldap/users.ldif
        owner: ldap
        group: ldap
        mode: '0644'
        content: |
          # Entry for OS proxy
          dn: cn=osproxy,ou=system,dc=amsa,dc=udl,dc=cat
          objectClass: organizationalRole
          objectClass: simpleSecurityObject
          cn: osproxy
          userPassword: {{ ldap_hash.stdout }}
          description: OS proxy for resolving UIDs/GIDs

          # Entries for groups
          dn: cn=programadors,ou=groups,dc=amsa,dc=udl,dc=cat
          objectClass: posixGroup
          cn: programadors
          gidNumber: 5000

          dn: cn=dissenyadors,ou=groups,dc=amsa,dc=udl,dc=cat
          objectClass: posixGroup
          cn: dissenyadors
          gidNumber: 5001

          # Entries for users
          dn: uid=jordi,ou=users,dc=amsa,dc=udl,dc=cat
          objectClass: posixAccount
          objectClass: shadowAccount
          objectClass: inetOrgPerson
          cn: jordi
          sn: mateo
          uidNumber: 4000
          gidNumber: 4000
          homeDirectory: /home/jordi
          loginShell: /bin/sh

          dn: uid=manel,ou=users,dc=amsa,dc=udl,dc=cat
          objectClass: posixAccount
          objectClass: shadowAccount
          objectClass: inetOrgPerson
          cn: manel
          sn: lopez
          uidNumber: 4001
          gidNumber: 4001
          homeDirectory: /home/manel
          loginShell: /bin/sh


    - name: Carregar usuaris i grups a la base de dades LDAP
      command: ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/users.ldif
      register: ldapadd_users_result
      changed_when: true


    - name: Crear fitxer users.ldif amb grups, rols i usuaris extra
      copy:
        dest: /etc/openldap/users.ldif
        owner: ldap
        group: ldap
        mode: '0644'
        content: |
          # Entries for POSIX groups
          dn: cn=programadors,ou=groups,dc=amsa,dc=udl,dc=cat
          objectClass: posixGroup
          cn: programadors
          gidNumber: 5000

          dn: cn=dissenyadors,ou=groups,dc=amsa,dc=udl,dc=cat
          objectClass: posixGroup
          cn: dissenyadors
          gidNumber: 5001

          # Rols d'aplicació
          dn: cn=alumne,ou=groups,dc=amsa,dc=udl,dc=cat
          objectClass: groupOfNames
          cn: alumne
          description: Rol d'alumne
          member: uid=alumne1,ou=users,dc=amsa,dc=udl,dc=cat
          member: uid=alumne2,ou=users,dc=amsa,dc=udl,dc=cat
          member: uid=alumne3,ou=users,dc=amsa,dc=udl,dc=cat
          member: uid=alumne4,ou=users,dc=amsa,dc=udl,dc=cat
          member: uid=alumne5,ou=users,dc=amsa,dc=udl,dc=cat
          member: uid=alumne6,ou=users,dc=amsa,dc=udl,dc=cat

          dn: cn=professor,ou=groups,dc=amsa,dc=udl,dc=cat
          objectClass: groupOfNames
          cn: professor
          description: Rol de professor
          member: uid=professor1,ou=users,dc=amsa,dc=udl,dc=cat
          member: uid=professor2,ou=users,dc=amsa,dc=udl,dc=cat

          dn: cn=admin,ou=groups,dc=amsa,dc=udl,dc=cat
          objectClass: groupOfNames
          cn: admin
          description: Rol d'administrador
          member: uid=admin1,ou=users,dc=amsa,dc=udl,dc=cat

          # Alumnes
          dn: uid=alumne1,ou=users,dc=amsa,dc=udl,dc=cat
          objectClass: posixAccount
          objectClass: shadowAccount
          objectClass: inetOrgPerson
          cn: Xavier
          sn: Giralt
          uidNumber: 5001
          gidNumber: 5001
          homeDirectory: /home/alumne1
          loginShell: /bin/bash
          mail: alumne1@amsa.udl.cat

          dn: uid=alumne2,ou=users,dc=amsa,dc=udl,dc=cat
          objectClass: posixAccount
          objectClass: shadowAccount
          objectClass: inetOrgPerson
          cn: Jonas
          sn: Obando
          uidNumber: 5002
          gidNumber: 5002
          homeDirectory: /home/alumne2
          loginShell: /bin/bash
          mail: alumne2@amsa.udl.cat

          dn: uid=alumne3,ou=users,dc=amsa,dc=udl,dc=cat
          objectClass: posixAccount
          objectClass: shadowAccount
          objectClass: inetOrgPerson
          cn: Jonas
          sn: Obando
          uidNumber: 5003
          gidNumber: 5003
          homeDirectory: /home/alumne3
          loginShell: /bin/bash
          mail: alumne3@amsa.udl.cat

          dn: uid=alumne4,ou=users,dc=amsa,dc=udl,dc=cat
          objectClass: posixAccount
          objectClass: shadowAccount
          objectClass: inetOrgPerson
          cn: Xavier
          sn: Giralt
          uidNumber: 5004
          gidNumber: 5004
          homeDirectory: /home/alumne4
          loginShell: /bin/bash
          mail: alumne4@amsa.udl.cat

          dn: uid=alumne5,ou=users,dc=amsa,dc=udl,dc=cat
          objectClass: posixAccount
          objectClass: shadowAccount
          objectClass: inetOrgPerson
          cn: Xavier
          sn: Giralt
          uidNumber: 5005
          gidNumber: 5005
          homeDirectory: /home/alumne5
          loginShell: /bin/bash
          mail: alumne5@amsa.udl.cat

          dn: uid=alumne6,ou=users,dc=amsa,dc=udl,dc=cat
          objectClass: posixAccount
          objectClass: shadowAccount
          objectClass: inetOrgPerson
          cn: Xavier
          sn: Giralt
          uidNumber: 5006
          gidNumber: 5006
          homeDirectory: /home/alumne6
          loginShell: /bin/bash
          mail: alumne6@amsa.udl.cat

          # Professors
          dn: uid=professor1,ou=users,dc=amsa,dc=udl,dc=cat
          objectClass: posixAccount
          objectClass: shadowAccount
          objectClass: inetOrgPerson
          cn: Jordi
          sn: Mateo
          uidNumber: 6001
          gidNumber: 6001
          homeDirectory: /home/professor1
          loginShell: /bin/bash
          mail: professor1@amsa.udl.cat

          dn: uid=professor2,ou=users,dc=amsa,dc=udl,dc=cat
          objectClass: posixAccount
          objectClass: shadowAccount
          objectClass: inetOrgPerson
          cn: Manel
          sn: Lopez
          uidNumber: 6002
          gidNumber: 6002
          homeDirectory: /home/professor2
          loginShell: /bin/bash
          mail: professor2@amsa.udl.cat

          # Administrador
          dn: uid=admin1,ou=users,dc=amsa,dc=udl,dc=cat
          objectClass: posixAccount
          objectClass: shadowAccount
          objectClass: inetOrgPerson
          cn: Administrator
          sn: Sistema
          uidNumber: 7001
          gidNumber: 7001
          homeDirectory: /home/admin1
          loginShell: /bin/bash
          mail: admin1@amsa.udl.cat

    - name: Afegir usuaris i grups a LDAP
      shell: |
        ldapadd -c -Y EXTERNAL -H ldapi:/// -f /etc/openldap/users.ldif
      register: users_result
      failed_when: 
        - users_result.rc != 0
        - users_result.rc != 68
      changed_when: users_result.rc == 0
    


    - name: Obtenir hostname públic d'AWS
      amazon.aws.ec2_metadata_facts:

    - name: Assignar hostname a variable commonname per poder fer servir a sota al camp CN
      set_fact:
        commonname: "{{ ansible_ec2_public_hostname }}"


    - name: Mostrar hostname per debug
      command: >
        bash -c 'echo "hostname:" > hostname.txt &&
                echo "{{ commonname }}" >> hostname.txt'




    - name: Crear certificat i clau amb openssl
      command: >
        openssl req -days 500 -newkey rsa:4096
        -keyout "{{ PATH_PKI }}/ldapkey.pem" -nodes
        -sha256 -x509 -out "{{ PATH_PKI }}/ldapcert.pem"
        -subj "/C={{ country }}/ST={{ state }}/L={{ locality }}/O={{ organization }}/OU={{ organizationalunit }}/CN={{ commonname }}/emailAddress={{ email }}"
      args:
        creates: "{{ PATH_PKI }}/ldapcert.pem"

    - name: Canviar propietari i permisos de la clau LDAP
      file:
        path: "{{ PATH_PKI }}/ldapkey.pem"
        owner: ldap
        group: ldap
        mode: '0400'

    - name: Crear còpia de cacerts.pem amb el certificat LDAP
      copy:
        src: "{{ PATH_PKI }}/ldapcert.pem"
        dest: "{{ PATH_PKI }}/cacerts.pem"
        owner: ldap
        group: ldap
        mode: '0644'

    - name: Assignar propietari i permisos de la clau LDAP
      file:
        path: "{{ PATH_PKI }}/ldapkey.pem"
        owner: ldap
        group: ldap
        mode: '0400'


    - name: Crear fitxer add-tls.ldif per configurar TLS a OpenLDAP
      copy:
        dest: /etc/openldap/add-tls.ldif
        owner: ldap
        group: ldap
        mode: '0644'
        content: |
          dn: cn=config
          changetype: modify
          add: olcTLSCACertificateFile
          olcTLSCACertificateFile: {{ PATH_PKI }}/cacerts.pem
          -
          add: olcTLSCertificateKeyFile
          olcTLSCertificateKeyFile: {{ PATH_PKI }}/ldapkey.pem
          -
          add: olcTLSCertificateFile
          olcTLSCertificateFile: {{ PATH_PKI }}/ldapcert.pem

    - name: Carregar configuració TLS a OpenLDAP
      command: ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/add-tls.ldif
      register: ldap_tls_result
      changed_when: true

    - name: Instalar Apache i extensions PHP necessàries per el LDAPAccountManager
      dnf:
        name:
          - httpd
          - php
          - php-ldap
          - php-mbstring
          - php-gd
          - php-gmp
          - php-zip
        state: present
        update_cache: yes

    - name: Habilitar i iniciar servei httpd
      systemd:
        name: httpd
        state: started
        enabled: yes

    - name: Descarregar paquet LAM
      get_url:
        url: https://github.com/LDAPAccountManager/lam/releases/download/9.0.RC1/ldap-account-manager-9.0.RC1-0.fedora.1.noarch.rpm
        dest: /tmp/ldap-account-manager-9.0.RC1-0.fedora.1.noarch.rpm
        mode: '0644'

    - name: Instalar paquet LAM
      dnf:
        name: /tmp/ldap-account-manager-9.0.RC1-0.fedora.1.noarch.rpm
        state: present
        disable_gpg_check: yes


    - name: Configuració LAM config.cfg
      become: yes
      copy:
        dest: /var/lib/ldap-account-manager/config/config.cfg
        content: |
          {
              "password": "{CRYPT-SHA512}$6$\/y4j5JMytunYqjS\/$Rh.w5sdgWIiB1sX1NfpDSoshT8beb1OiPJ9I25.L1W94wVLcHDFwiM6W6pMnK389c.zJDno1KjqaR07m3DtfE0 L3k0ajVKTXl0dW5ZcWpTLw==",
              "default": "lam",
              "sessionTimeout": "30",
              "hideLoginErrorDetails": "false",
              "logLevel": "4",
              "logDestination": "SYSLOG",
              "allowedHosts": "",
              "passwordMinLength": "10",
              "passwordMinUpper": "0",
              "passwordMinLower": "0",
              "passwordMinNumeric": "0",
              "passwordMinClasses": "0",
              "passwordMinSymbol": "0",
              "checkedRulesCount": "-1",
              "passwordMustNotContainUser": "false",
              "passwordMustNotContain3Chars": "false",
              "externalPwdCheckUrl": "",
              "errorReporting": "default",
              "allowedHostsSelfService": "",
              "license": "",
              "licenseEmailFrom": "",
              "licenseEmailTo": "",
              "licenseWarningType": "all",
              "licenseEmailDateSent": "",
              "mailServer": "",
              "mailUser": "",
              "mailPassword": "",
              "mailEncryption": "TLS",
              "mailAttribute": "mail",
              "mailBackupAttribute": "passwordselfresetbackupmail",
              "configDatabaseType": "files",
              "configDatabaseServer": "",
              "configDatabasePort": "",
              "configDatabaseName": "",
              "configDatabaseUser": "",
              "configDatabasePassword": "",
              "moduleSettings": "eyJyZXF1ZXN0QWNjZXNzIjp7Imhpc3RvcnlSZXRlbnRpb25QZXJpb2QiOiIzNjUwIiwiZXhwaXJhdGlvblBlcmlvZCI6IjMwIn19"
          }
        owner: apache
        group: apache
        mode: '0600'

    - name: Configuració LAM lam.conf
      become: yes
      copy:
        dest: /var/lib/ldap-account-manager/config/lam.conf
        content: |
          {
              "ServerURL": "ldap:\/\/localhost:389",
              "useTLS": "no",
              "followReferrals": "false",
              "pagedResults": "false",
              "Passwd": "{CRYPT-SHA512}$6$WEq8KpaLnBZnAeVd$3ppdn3Q746wqFjQDb3rRN9xEGwjdDv2go\/BA1HpsvnMx0FDyCkC7ZC1gke0bWidB\/9491vpEygk6Y0d3ZFK\/M\/ V0VxOEtwYUxuQlpuQWVWZA==",
              "Admins": "cn=osproxy,ou=system,dc=amsa,dc=udl,dc=cat",
              "defaultLanguage": "en_GB.utf8",
              "scriptPath": "",
              "scriptServer": "",
              "scriptRights": "750",
              "serverDisplayName": "",
              "activeTypes": "user,group",
              "accessLevel": "100",
              "loginMethod": "list",
              "loginSearchSuffix": "dc=yourdomain,dc=org",
              "loginSearchFilter": "uid=%USER%",
              "searchLimit": "0",
              "lamProMailFrom": "noreply@example.com",
              "lamProMailReplyTo": "",
              "lamProMailSubject": "Your password was reset",
              "lamProMailText": "Dear @@givenName@@ @@sn@@,+::++::+your password was reset to: @@newPassword@@+::++::++::+Best regards+::++::+deskside support+::+",
              "lamProMailIsHTML": "false",
              "lamProMailAllowAlternateAddress": "true",
              "httpAuthentication": "false",
              "loginSearchDN": "",
              "loginSearchPassword": "",
              "timeZone": "Europe\/London",
              "jobsBindUser": null,
              "jobsBindPassword": null,
              "jobsDatabase": null,
              "jobsDBHost": null,
              "jobsDBPort": null,
              "jobsDBUser": null,
              "jobsDBPassword": null,
              "jobsDBName": null,
              "pwdResetAllowSpecificPassword": "true",
              "pwdResetAllowScreenPassword": "true",
              "pwdResetForcePasswordChange": "true",
              "pwdResetDefaultPasswordOutput": "2",
              "scriptUserName": "",
              "scriptSSHKey": "",
              "scriptSSHKeyPassword": "",
              "twoFactorAuthentication": "none",
              "twoFactorAuthenticationURL": "https:\/\/localhost",
              "twoFactorAuthenticationInsecure": false,
              "twoFactorAuthenticationLabel": "",
              "twoFactorAuthenticationOptional": false,
              "twoFactorAuthenticationCaption": "",
              "twoFactorAuthenticationClientId": "",
              "twoFactorAuthenticationSecretKey": "",
              "twoFactorAuthenticationDomain": "",
              "twoFactorAuthenticationAttribute": "uid",
              "twoFactorAllowToRememberDevice": "false",
              "twoFactorRememberDeviceDuration": "28800",
              "twoFactorRememberDevicePassword": "uZ0TJJUrHtUO6VcVFouw9zlk0zMRtV",
              "referentialIntegrityOverlay": "false",
              "hidePasswordPromptForExpiredPasswords": "false",
              "hideDnPart": "",
              "pwdPolicyMinLength": "",
              "pwdPolicyMinLowercase": "",
              "pwdPolicyMinUppercase": "",
              "pwdPolicyMinNumeric": "",
              "pwdPolicyMinSymbolic": "",
              "typeSettings": {
                  "suffix_user": "ou=users,dc=amsa,dc=udl,dc=cat",
                  "attr_user": "#uid;#givenName;#sn;#uidNumber;#gidNumber",
                  "modules_user": "inetOrgPerson,posixAccount,shadowAccount",
                  "suffix_group": "ou=groups,dc=amsa,dc=udl,dc=cat",
                  "attr_group": "#cn;#gidNumber;#memberUID;#description",
                  "modules_group": "posixGroup",
                  "customLabel_user": "",
                  "filter_user": "",
                  "customLabel_group": "",
                  "filter_group": "",
                  "hidden_user": false,
                  "hidden_group": false
              },
              "moduleSettings": {
                  "posixAccount_user_minUID": [
                      "10000"
                  ],
                  "posixAccount_user_maxUID": [
                      "30000"
                  ],
                  "posixAccount_host_minMachine": [
                      "50000"
                  ],
                  "posixAccount_host_maxMachine": [
                      "60000"
                  ],
                  "posixGroup_group_minGID": [
                      "10000"
                  ],
                  "posixGroup_group_maxGID": [
                      "20000"
                  ],
                  "posixAccount_user_uidGeneratorUsers": [
                      "range"
                  ],
                  "posixAccount_host_uidGeneratorUsers": [
                      "range"
                  ],
                  "posixAccount_group_gidGeneratorUsers": [
                      "range"
                  ],
                  "posixGroup_pwdHash": [
                      "SSHA"
                  ],
                  "posixAccount_pwdHash": [
                      "SSHA"
                  ]
              },
              "toolSettings": {
                  "treeViewSuffix": "dc=amsa,dc=udl,dc=cat",
                  "tool_hide_toolFileUpload": "false",
                  "tool_hide_ImportExport": "false",
                  "tool_hide_toolMultiEdit": "false",
                  "tool_hide_toolOUEditor": "false",
                  "tool_hide_toolPDFEditor": "false",
                  "tool_hide_toolProfileEditor": "false",
                  "tool_hide_toolSchemaBrowser": "false",
                  "tool_hide_toolServerInformation": "false",
                  "tool_hide_toolTests": "false",
                  "tool_hide_TreeViewTool": "false",
                  "tool_hide_toolWebauthn": "false"
              },
              "jobSettings": []
          }
        owner: root
        group: root
        mode: '0644'



    - name: Python HTTP Server per passar el certificat al client
      shell: |
        cd /etc/pki/tls
        nohup python3 -m http.server 8000 &
      args:
        executable: /bin/bash


