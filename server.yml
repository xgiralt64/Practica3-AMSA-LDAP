---
- name: Configuració Server
  become: yes
  hosts: localhost
  vars:
    PASSWORD: "1234"
    BASE: "dc=amsa,dc=udl,dc=cat"



  tasks:
    - name: Actualitzar repositoris
      dnf:
        name: "*"
        state: latest

    - name: Instalar paquets necessaris
      dnf:
          name:
            - cyrus-sasl-devel
            - make
            - libtool
            - autoconf
            - libtool-ltdl-devel
            - openssl-devel
            - libdb-devel
            - tar
            - gcc
            - perl
            - perl-devel
            - wget
            - vim
          state: present
          update_cache: yes
    
    - name: Instalar OpenLDAP
      vars:
        openldap_ver: "2.6.3"
      shell: |
        wget ftp://ftp.openldap.org/pub/OpenLDAP/openldap-release/openldap-{{ openldap_ver }}.tgz
        tar xzf openldap-{{ openldap_ver }}.tgz
        cd openldap-{{ openldap_ver }}
        ./configure --prefix=/usr --sysconfdir=/etc --disable-static \
          --enable-debug --with-tls=openssl --with-cyrus-sasl --enable-dynamic \
          --enable-crypt --enable-spasswd --enable-slapd --enable-modules \
          --enable-rlookups --disable-sql --enable-ppolicy --enable-syslog
        make depend
        make
        cd contrib/slapd-modules/passwd/sha2
        make
        cd ../../../..
        make install
        cd contrib/slapd-modules/passwd/sha2
        make install
      args:
        chdir: /tmp

    - name: Crear grup ldap amb gid 55
      group:
        name: ldap
        gid: 55
        state: present

    - name: Crear usuari ldap amb uid 55
      user:
        name: ldap
        uid: 55
        group: ldap
        home: /var/lib/openldap
        shell: /usr/sbin/nologin
        system: yes
        create_home: no
        state: present

    - name: Crear directoris necessaris
      file:
        path: "{{ item }}"
        state: directory
        owner: ldap
        group: ldap
        mode: "0755"
      loop:
        - /var/lib/openldap
        - /etc/openldap/slapd.d

    - name: Assignar propietari al directori /var/lib/openldap
      file:
        path: /var/lib/openldap
        owner: ldap
        group: ldap
        state: directory

    - name: Assignar propietari i permisos a /etc/openldap/slapd.conf
      file:
        path: /etc/openldap/slapd.conf
        owner: root
        group: ldap
        mode: "0640"
        state: file

    - name: Crear unitat systemd per a slapd
      copy:
        dest: /etc/systemd/system/slapd.service
        owner: root
        group: root
        mode: '0644'
        content: |
          [Unit]
          Description=OpenLDAP Server Daemon
          After=syslog.target network-online.target
          Documentation=man:slapd
          Documentation=man:slapd-mdb

          [Service]
          Type=forking
          PIDFile=/var/lib/openldap/slapd.pid
          Environment="SLAPD_URLS=ldap:/// ldapi:/// ldaps:///"
          Environment="SLAPD_OPTIONS=-F /etc/openldap/slapd.d"
          ExecStart=/usr/libexec/slapd -u ldap -g ldap -h ${SLAPD_URLS} $SLAPD_OPTIONS

          [Install]
          WantedBy=multi-user.target

    - name: Recarregar systemd
      systemd:
        daemon_reload: yes

    - name: Habilitar el servei slapd
      systemd:
        name: slapd
        enabled: yes
    
    - name: Generar hash SSHA512 de la contrasenya
      command: >
        slappasswd -h "{SSHA512}"
        -o module-load=pw-sha2.la
        -o module-path=/usr/local/libexec/openldap
        -s {{ PASSWORD }}
      register: ldap_hash
      changed_when: true

    - name: Crear slapd.ldif
      copy:
        dest: /etc/openldap/slapd.ldif
        owner: root
        group: root
        mode: '0644'
        content: |
          dn: cn=config
          objectClass: olcGlobal
          cn: config
          olcArgsFile: /var/lib/openldap/slapd.args
          olcPidFile: /var/lib/openldap/slapd.pid
          olcTLSCipherSuite: TLSv1.2:HIGH:\!aNULL:\!eNULL
          olcTLSProtocolMin: 3.3

          dn: cn=schema,cn=config
          objectClass: olcSchemaConfig
          cn: schema

          dn: cn=module,cn=config
          objectClass: olcModuleList
          cn: module
          olcModulepath: /usr/libexec/openldap
          olcModuleload: back_mdb.la

          dn: cn=module,cn=config
          objectClass: olcModuleList
          cn: module
          olcModulepath: /usr/local/libexec/openldap
          olcModuleload: pw-sha2.la

          include: file:///etc/openldap/schema/core.ldif
          include: file:///etc/openldap/schema/cosine.ldif
          include: file:///etc/openldap/schema/nis.ldif
          include: file:///etc/openldap/schema/inetorgperson.ldif

          dn: olcDatabase=frontend,cn=config
          objectClass: olcDatabaseConfig
          objectClass: olcFrontendConfig
          olcDatabase: frontend
          olcPasswordHash: {{ ldap_hash.stdout }}
          olcAccess: to dn.base="cn=Subschema" by * read
          olcAccess: to *
            by dn.base="gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth" manage
            by * none

          dn: olcDatabase=config,cn=config
          objectClass: olcDatabaseConfig
          olcDatabase: config
          olcRootDN: cn=config
          olcAccess: to *
            by dn.base="gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth" manage
            by * none

    - name: Importar slapd.ldif a slapd.d
      command: >
        slapadd -n 0 -F /etc/openldap/slapd.d
        -l /etc/openldap/slapd.ldif
      args:
        chdir: /etc/openldap
      register: slapadd_result
      changed_when: true

    - name: Assegurar permisos de slapd.d
      file:
        path: /etc/openldap/slapd.d
        owner: ldap
        group: ldap
        recurse: yes
    
    - name: Activar i iniciar slapd
      systemd:
        name: slapd
        enabled: yes
        state: started
        daemon_reload: yes

    - name: Crear rootdn.ldif
      copy:
        dest: /etc/openldap/rootdn.ldif
        owner: root
        group: root
        mode: '0644'
        content: |
          dn: olcDatabase=mdb,cn=config
          objectClass: olcDatabaseConfig
          objectClass: olcMdbConfig
          olcDatabase: mdb
          olcDbMaxSize: 42949672960
          olcDbDirectory: /var/lib/openldap
          olcSuffix: {{ BASE }}
          olcRootDN: cn=admin,{{ BASE }}
          olcRootPW: {{ ldap_hash.stdout }}
          olcDbIndex: uid pres,eq
          olcDbIndex: cn,sn pres,eq,approx,sub
          olcDbIndex: mail pres,eq,sub
          olcDbIndex: objectClass pres,eq
          olcDbIndex: loginShell pres,eq
          olcAccess: to attrs=userPassword,shadowLastChange,shadowExpire
            by self write
            by anonymous auth
            by dn.subtree="gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth" manage
            by dn.subtree="ou=system,{{ BASE }}" read
            by * none
          olcAccess: to dn.subtree="ou=system,{{ BASE }}"
            by dn.subtree="gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth" manage
            by * none
          olcAccess: to dn.subtree="{{ BASE }}"
            by dn.subtree="gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth" manage
            by users read
            by * none



    - name: Importar base de dades MDB a cn=config
      command: >
        ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/rootdn.ldif
      register: ldapadd_result
      changed_when: true

    - name: Crear fitxer basedn.ldif
      copy:
        dest: /tmp/basedn.ldif
        content: |
          dn: dc=amsa,dc=udl,dc=cat
          objectClass: dcObject
          objectClass: organization
          objectClass: top
          o: AMSA
          dc: amsa

          dn: ou=groups,dc=amsa,dc=udl,dc=cat
          objectClass: organizationalUnit
          objectClass: top
          ou: groups

          dn: ou=users,dc=amsa,dc=udl,dc=cat
          objectClass: organizationalUnit
          objectClass: top
          ou: users

          dn: ou=system,dc=amsa,dc=udl,dc=cat
          objectClass: organizationalUnit
          objectClass: top
          ou: system
        owner: root
        group: root
        mode: '0644'
    
    
- name: Configurar LDAP i TLS
  hosts: localhost
  become: yes
  vars:
    BASE: "dc=amsa,dc=udl,dc=cat"
    groups:
      - name: "programadors"
        gid: 5000
      - name: "dissenyadors"
        gid: 5001
    users:
      - name: "ramon"
        sn: "mateo"
        uid: 4000
      - name: "manel"
        sn: "lopez"
        uid: 4001
    PATH_PKI: "/etc/pki/tls"
    country: "ES"
    state: "Spain"
    locality: "Igualada"
    organization: "UdL"
    organizationalunit: "IT"
    email: "admin@udl.cat"

  tasks:
    - name: Crear fitxer users.ldif
      copy:
        dest: /tmp/users.ldif
        content: |
          dn: cn=osproxy,ou=system,{{ BASE }}
          objectClass: organizationalRole
          objectClass: simpleSecurityObject
          cn: osproxy
          userPassword: {{ ldap_hash.stdout }}
          description: OS proxy for resolving UIDs/GIDs

          dn: ou=groups,{{ BASE }}
          objectClass: posixGroup
          ou: groups

          dn: ou=users,{{ BASE }}
          objectClass: posixGroup
          ou: users

          {% for g in groups %}
          dn: cn={{ g.name }},ou=groups,{{ BASE }}
          objectClass: posixGroup
          cn: {{ g.name }}
          gidNumber: {{ g.gid }}

          {% endfor %}

          {% for u in users %}
          dn: uid={{ u.name }},ou=users,{{ BASE }}
          objectClass: posixAccount
          objectClass: shadowAccount
          objectClass: inetOrgPerson
          cn: {{ u.name }}
          sn: {{ u.sn }}
          uidNumber: {{ u.uid }}
          gidNumber: {{ u.uid }}
          homeDirectory: /home/{{ u.name }}
          loginShell: /bin/sh

          {% endfor %}

    - name: Carregar users.ldif a la base de dades
      command: ldapadd -Y EXTERNAL -H ldapi:/// -f /tmp/users.ldif
      register: ldapadd_result
      changed_when: true

    - name: Obtenir hostname públic d'AWS (si és EC2)
      amazon.aws.ec2_metadata_facts:

    - name: Assignar hostname a variable commonname
      set_fact:
        commonname: "{{ ansible_ec2_public_hostname | default(ansible_fqdn) }}"

    - name: Crear certificat i clau amb openssl
      command: >
        openssl req -days 500 -newkey rsa:4096
        -keyout "{{ PATH_PKI }}/ldapkey.pem"
        -nodes -sha256 -x509
        -out "{{ PATH_PKI }}/ldapcert.pem"
        -subj "/C={{ country }}/ST={{ state }}/L={{ locality }}/O={{ organization }}/OU={{ organizationalunit }}/CN={{ commonname }}/emailAddress={{ email }}"
      args:
        creates: "{{ PATH_PKI }}/ldapcert.pem"

    - name: Canviar propietari de la clau LDAP
      file:
        path: "{{ PATH_PKI }}/ldapkey.pem"
        owner: ldap
        group: ldap
        mode: '0400'

    - name: Crear copia de cacerts.pem amb el certificat LDAP
      copy:
        src: "{{ PATH_PKI }}/ldapcert.pem"
        dest: "{{ PATH_PKI }}/cacerts.pem"
        owner: root
        group: root
        mode: '0644'

    - name: Crear fitxer add-tls.ldif
      copy:
        dest: /etc/openldap/add-tls.ldif
        content: |
          dn: cn=config
          changetype: modify
          add: olcTLSCACertificateFile
          olcTLSCACertificateFile: "{{ PATH_PKI }}/cacerts.pem"
          -
          add: olcTLSCertificateKeyFile
          olcTLSCertificateKeyFile: "{{ PATH_PKI }}/ldapkey.pem"
          -
          add: olcTLSCertificateFile
          olcTLSCertificateFile: "{{ PATH_PKI }}/ldapcert.pem"
        owner: root
        group: root
        mode: '0644'

    - name: Carregar configuració TLS a OpenLDAP
      command: ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/add-tls.ldif
      args:
        creates: /etc/openldap/add-tls.ldif
